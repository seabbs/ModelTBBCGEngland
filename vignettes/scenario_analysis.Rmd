---
title: "Model Report"
author: "Sam Abbott"
date: "`r Sys.Date()`"
output: html_document
params: 
  model: ""
  model_dir: "results/model-run-2018-09-07_12:11:07"
vignette: >
  %\VignetteIndexEntry{Model Report}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}

---

```{r setup, include=FALSE}
if (!exists("model")) {
  model <- ""
}

if (!exists("model_dir")) {
  model_dir <- "results/model-run-2018-09-14_11:20:31"
}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, 
                      message = TRUE, cache = FALSE,
                      fig.path = file.path(model_dir, "plots"),
                      cache.path = file.path(model_dir, "report-cache"),
                      fig.align = 'center',
                      fig.length = 8, fig.width = 8)
```

# Set-up
- Load packages required for analysis

```{r, packages, message = FALSE}
library(tidyverse)
library(rbi)
library(rbi.helpers)
library(prettypublisher)
library(ModelTBBCGEngland)
```


- Load the fitted model and prior draws.

```{r}

if (class(model) %in% "character") {
  model <- ModelTBBCGEngland::read_libbi(file.path(model_dir, "libbi", "posterior"))
}

priors <- readRDS(file.path(model_dir, "data", "prior-params.rds"))

model
```

# Scenarios

- Outline future scenarios

```{r}
future_cutoff <- 2040
start_time <- 1931
end_time <- future_cutoff - start_time
input <- setup_model_input(run_time = end_time, time_scale_numeric = 1)
```

- Future already predicted for baseline scenario (school age vaccination)

```{r}
baseline_scenario <- model
```

- Predict future for no vaccination scenario

```{r}
no_vac_model <- model
no_vac_model$model <- no_vac_model$model %>% 
  fix(vac_scheme = 2)

no_vac_scenario <- sample(no_vac_model)
```


- Predict future for neonatal vaccination

```{r}
neonatal_model <- model
neonatal_model$model <- neonatal_model$model %>% 
  fix(vac_scheme = 1)

no_vac_scenario <- sample(neonatal_model)
```

- List all models and assign names

```{r}
models <- list(baseline_scenario, neonatal_model, no_vac_model)
names(models) <- c("School-age BCG", "Neonatal BCG", "No BCG")
```

# Generate summarised output

- Plot an overview of states 

```{r overview-scenarios, fig.height = 16, fig.width = 16}
plot_state(models, summarise = TRUE)
```

- Plot an overview of states zoomed into 1980 onwards

```{r overview-states-1990, fig.height = 16, fig.width = 16}
plot_state(model, summarise = TRUE, start_time = 49)
```

- Plot fitted observed states.

```{r overview-states-1990-obs}
plot_state(model, states = c("YearlyHistPInc", "YearlyInc"), start_time = 49)
```

- Table fitted states

```{r}
pred_obs <- plot_state(model, states = c("YearlyHistPInc", "YearlyInc", "YearlyAgeInc"), summarise = FALSE, start_time = 59, plot_data = FALSE)

obs <- ModelTBBCGEngland::setup_model_obs() %>% 
  bind_rows(.id = "state") %>% 
  mutate(time = time + 1931)

pred_obs <- pred_obs %>% 
  dplyr::filter(Average == "median") %>% 
  mutate(pred_value = pretty_ci(Count, lll, hhh, digits = 0)) %>% 
  left_join(obs, by = c("state" = "state", "time" = "time", "age" = "age")) %>% 
  select(Observation = state, Age = age, Year = time,  `Observed Incidence` = value, `Predicted Incidence` = pred_value) %>% 
  mutate(Year = Year + 1931)


sum_obs_table <- pred_obs %>% 
  dplyr::filter(Observation %in% c("YearlyInc", "YearlyHistPInc")) %>% 
  drop_na(`Observed Incidence`) %>% 
  select(-Age) %>% 
  mutate(Observation = case_when(Observation == "YearlyInc" ~ "All TB cases",
                                 Observation == "YearlyHistPInc" ~ "Pulmonary TB cases"))


saveRDS(sum_obs_table, file.path(model_dir, "data", "sum_obs_table.rds"))

age_cases_table <- pred_obs %>% 
  dplyr::filter(Observation %in% c("YearlyAgeInc")) %>% 
  drop_na(`Observed Incidence`) %>% 
  select(-Observation) %>% 
  group_by(Year) %>% 
  mutate(Age = c(paste0(seq(0, 65, 5), "-", seq(4, 69, 5)), "70-89")) %>% 
  ungroup


saveRDS(age_cases_table, file.path(model_dir, "data", "age_cases_table.rds"))
```

```{r}
knitr::kable(sum_obs_table)
```

```{r}
knitr::kable(age_cases_table)
```

- Plot age distributed cases.

```{r overview-states-1990-age}
plot_state(model, states = c("YearlyAgeInc"), start_time = 59) + theme(legend.position = "none")
```
