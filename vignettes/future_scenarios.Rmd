---
title: "Model Report"
author: "Sam Abbott"
date: "`r Sys.Date()`"
output: html_document
params: 
  model: ""
  model_dir: "results/evaluated-scenarios-2019-03-26_22:30:59/baseline-2019-03-26_22:31:00"
  nthreads: 1
vignette: >
  %\VignetteIndexEntry{Model Report}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}

---

```{r setup, include=FALSE}
if (!exists("model")) {
  model <- ""
}

if (!exists("nthread")) {
  nthreads <- future::availableCores()[[1]]
}

if (!exists("model_dir")) {
  model_dir <- "results/evaluated-scenarios-2019-03-26_22:30:59/baseline-2019-03-26_22:31:00"
}

store_path <- ifelse(grepl("vignettes", model_dir), file.path("..", model_dir), model_dir)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, 
                      message = TRUE, cache = FALSE,
                      fig.path = file.path(store_path, "plots/"),
                      cache.path = file.path(store_path , "reports", "future_scenarios/"),
                      fig.align = 'center',
                      fig.length = 8, fig.width = 8)
```

# Set-up

- Load packages required for analysis

```{r, packages, message = FALSE}
library(tidyverse)
library(rbi)
library(rbi.helpers)
library(prettypublisher)
library(ModelTBBCGEngland)
```


- Load the fitted model and prior draws.

```{r load-model}
if (class(model) %in% "character"){
  model <- ModelTBBCGEngland::read_libbi(file.path(model_dir, "libbi", "posterior"))
}

model
```

# Scenarios

- Set up settings for prediction

```{r}
run_time <- 2040 - 1931
 
scenario_prediction <-partial(predict,
                      with = "transform-obs-to-state",
                      end_time = run_time, 
                      noutputs = run_time,
                      nthreads = nthreads)
```
- Predict future for baseline scenario (school age vaccination).

```{r baseline, include = FALSE}
baseline_scenario <- scenario_prediction(model)
```

- Predict future for no vaccination scenario

```{r no-vac, include = FALSE}
no_vac_model <- baseline_scenario
no_vac_model$model <- no_vac_model$model %>% 
  fix(vac_scheme = 2)

no_vac_scenario <- scenario_prediction(no_vac_model)
```


- Predict future for neonatal vaccination

```{r neonatal, include = FALSE}
neonatal_model <- baseline_scenario
neonatal_model$model <- neonatal_model$model %>% 
  fix(vac_scheme = 1)

neonatal_scenario <- scenario_prediction(neonatal_model)
```

- List all models and assign names

```{r}
models <- list(baseline_scenario, neonatal_scenario, no_vac_scenario)
names(models) <- c("School-age BCG", "Neonatal BCG", "No BCG")
```

# Generate summarised output

- Plot an overview of states 

```{r overview-scenarios, fig.height = 16, fig.width = 16}
plot_state(models, summarise = TRUE)
```

- Plot an overview of states zoomed into 2000 onwards

```{r overview-scenarios-2000, fig.height = 16, fig.width = 16}
plot_state(models, summarise = TRUE, start_time = 69)
```

- Plot fitted observed states.

```{r overview-scenarios-2000-obs}
plot_state(models, states =  c("YearlyHistPInc", "YearlyChildInc", "YearlyAdultInc", "YearlyOlderAdultInc"),
           start_time = 69)
```

- Table fitted states

```{r}
pred_obs <- plot_state(models, states = c("YearlyInc", "YearlyAgeInc", "YearlyChildInc", "YearlyAdultInc", "YearlyOlderAdultInc"), 
                       summarise = FALSE, start_time = 74, plot_data = FALSE) %>% 
  mutate(state = factor(state, levels = c("YearlyInc", "YearlyAgeInc",
                                          "YearlyChildInc", "YearlyAdultInc", 
                                          "YearlyOlderAdultInc")))



pred_obs <- pred_obs %>% 
  dplyr::filter(Average == "median") %>% 
  mutate(pred_value = pretty_ci(Count, lll, hhh, digits = 0)) %>% 
  select(Scenario, Observation = state, Age = age, Year = time, `Predicted Incidence` = pred_value)


sum_scenario_table <- pred_obs %>% 
  dplyr::filter(Observation %in% c("YearlyInc", "YearlyChildInc", "YearAdultInc", "YearOlderAdultInc")) %>% 
  select(-Age) %>% 
  spread(Scenario, `Predicted Incidence`)


saveRDS(sum_scenario_table, file.path(model_dir, "data", "sum_scenario_table.rds"))

age_cases_scenario_table <- pred_obs %>% 
  dplyr::filter(Observation %in% c("YearlyAgeInc")) %>% 
  spread(Scenario, `Predicted Incidence`) %>% 
  select(-Observation) %>% 
  group_by(Year) %>% 
  mutate(Age = c(paste0(seq(0, 45, 5), "-", seq(4, 49, 5)), "50-69", "70-89"))  %>% 
  ungroup


saveRDS(age_cases_scenario_table, file.path(model_dir, "data", "age_cases_scenario_table.rds"))
```

```{r, eval = FALSE}
sum_scenario_table %>% 
  dplyr::filter(Year %% 10 == 0) %>%
  mutate(Observation = Observation %>% 
           replace(Observation == lag(Observation), "")) %>% 
  knitr::kable()
```

- Plot concentrated age distributed cases

```{r overview-scenarios-con-age}
plot_state(models, states = c( "YearlyChildInc", "YearlyAdultInc", "YearlyOlderAdultInc"), start_time = 69) + theme(legend.position = "none")
```

- Plot age distributed cases.

```{r overview-scenarios-age, fig.height = 16, fig.width = 16}
plot_state(models, states = c("YearlyAgeInc"), start_time = 69) + theme(legend.position = "none")
```
