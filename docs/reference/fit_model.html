<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Fit Model — fit_model • ModelTBBCGEngland</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script>

<!-- sticky kit -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>



<meta property="og:title" content="Fit Model — fit_model" />

<meta property="og:description" content="A function to fit the models in development through the full fitting pipeline based on synthetic data or observed data." />
<meta name="twitter:card" content="summary" />



<!-- mathjax -->
<script src='https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ModelTBBCGEngland</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/seabbs/ModelTBBCGEngland">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Fit Model</h1>
    <small class="dont-index">Source: <a href='https://github.com/seabbs/ModelTBBCGEngland/blob/master/R/fit_model.R'><code>R/fit_model.R</code></a></small>
    <div class="hidden name"><code>fit_model.Rd</code></div>
    </div>

    <div class="ref-description">
    
    <p>A function to fit the models in development through the full fitting pipeline based on synthetic data or observed data.</p>
    
    </div>

    <pre class="usage"><span class='fu'>fit_model</span>(<span class='kw'>model</span> <span class='kw'>=</span> <span class='st'>"BaseLineModel"</span>, <span class='kw'>previous_model_path</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>gen_data</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>, <span class='kw'>run_time</span> <span class='kw'>=</span> <span class='fl'>73</span>, <span class='kw'>time_scale</span> <span class='kw'>=</span> <span class='st'>"year"</span>,
  <span class='kw'>plot_obs</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>, <span class='kw'>sample_priors</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>, <span class='kw'>prior_samples</span> <span class='kw'>=</span> <span class='fl'>1000</span>,
  <span class='kw'>nparticles</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>adapt_particles</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,
  <span class='kw'>adapt_part_samples</span> <span class='kw'>=</span> <span class='fl'>1000</span>, <span class='kw'>adapt_part_it</span> <span class='kw'>=</span> <span class='fl'>10</span>, <span class='kw'>min_particles</span> <span class='kw'>=</span> <span class='fl'>4</span>,
  <span class='kw'>max_particles</span> <span class='kw'>=</span> <span class='fl'>16</span>, <span class='kw'>proposal_param_block</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>proposal_initial_block</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>adapt_proposal</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,
  <span class='kw'>adapt_prop_samples</span> <span class='kw'>=</span> <span class='fl'>1000</span>, <span class='kw'>adapt_prop_it</span> <span class='kw'>=</span> <span class='fl'>10</span>, <span class='kw'>adapt</span> <span class='kw'>=</span> <span class='st'>"both"</span>,
  <span class='kw'>adapt_scale</span> <span class='kw'>=</span> <span class='fl'>2</span>, <span class='kw'>min_acc</span> <span class='kw'>=</span> <span class='fl'>0.2</span>, <span class='kw'>max_acc</span> <span class='kw'>=</span> <span class='fl'>0.4</span>, <span class='kw'>fit</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,
  <span class='kw'>posterior_samples</span> <span class='kw'>=</span> <span class='fl'>10000</span>, <span class='kw'>thin</span> <span class='kw'>=</span> <span class='fl'>10</span>, <span class='kw'>burn_prop</span> <span class='kw'>=</span> <span class='fl'>0</span>,
  <span class='kw'>nthreads</span> <span class='kw'>=</span> <span class='kw pkg'>parallel</span><span class='kw ns'>::</span><span class='fu'><a href='http://www.rdocumentation.org/packages/parallel/topics/detectCores'>detectCores</a></span>(), <span class='kw'>verbose</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>,
  <span class='kw'>libbi_verbose</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>, <span class='kw'>fitting_verbose</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>, <span class='kw'>browse</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,
  <span class='kw'>const_pop</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>, <span class='kw'>no_age</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>, <span class='kw'>no_disease</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,
  <span class='kw'>save_output</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>, <span class='kw'>dir_path</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>dir_name</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>seed</span> <span class='kw'>=</span> <span class='fl'>1234</span>)</pre>
    
    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>model</th>
      <td><p>A character string containing the model name. Alternatively a model loaded via <code><a href='http://www.rdocumentation.org/packages/rbi/topics/bi_model'>rbi::bi_model</a></code> may be passed.</p></td>
    </tr>
    <tr>
      <th>previous_model_path</th>
      <td><p>A character string giving the path to a previous LiBBi model (saved as an .rds). This will replace the default model and
override initial settings.</p></td>
    </tr>
    <tr>
      <th>gen_data</th>
      <td><p>Logical, defaults to /codeTRUE. Should data be synthesised using the model and priors.</p></td>
    </tr>
    <tr>
      <th>run_time</th>
      <td><p>Numeric, the number of years to run the model fitting and simulation for, defaults to 74 (i.e from 1931 until 2005).</p></td>
    </tr>
    <tr>
      <th>time_scale</th>
      <td><p>Character, defaults to <code>"year"</code>. A monthly timescale can also be set with <code>"month" </code>.</p></td>
    </tr>
    <tr>
      <th>plot_obs</th>
      <td><p>Logical, defaults to <code>TRUE</code>. Should input data be plotted</p></td>
    </tr>
    <tr>
      <th>sample_priors</th>
      <td><p>Logical, defaults to <code>FALSE</code>. Should the model priors be sampled.</p></td>
    </tr>
    <tr>
      <th>prior_samples</th>
      <td><p>Numeric, the number of samples to take from the priors. Defaults to 1000.</p></td>
    </tr>
    <tr>
      <th>nparticles</th>
      <td><p>Numeric, the initial number of particles to use in the particle filters. Defaults to <code>NULL</code>, in which case the number of outputs
is used as the initial particle number.</p></td>
    </tr>
    <tr>
      <th>adapt_particles</th>
      <td><p>Logical, defaults to <code>FALSE</code>. Should the number of particles be adapted.</p></td>
    </tr>
    <tr>
      <th>adapt_part_samples</th>
      <td><p>Numeric, the number of samples to take from the priors when adapting the number of particles. Defaults to 1000.</p></td>
    </tr>
    <tr>
      <th>adapt_part_it</th>
      <td><p>Numeric, the number of iterations to use for adapting the number of particles. Defaults to 10.</p></td>
    </tr>
    <tr>
      <th>min_particles</th>
      <td><p>Numeric, defaults to 4. The starting number of particles to use for adpation.</p></td>
    </tr>
    <tr>
      <th>max_particles</th>
      <td><p>Numeric, defaults to 16. The maximum number of particles to use for apation.</p></td>
    </tr>
    <tr>
      <th>proposal_param_block</th>
      <td><p>A character string containing a LiBBi proposal parameter block. Defaults to <code>NULL</code> in
which case the LiBBi defaults will be used.</p></td>
    </tr>
    <tr>
      <th>proposal_initial_block</th>
      <td><p>A character string containing a LiBBi proposal initial block. Defaults to <code>NULL</code> in
which case the LiBBi defaults will be used.</p></td>
    </tr>
    <tr>
      <th>adapt_proposal</th>
      <td><p>Logical, defaults to <code>TRUE</code>. Should the proposal be adjusted to improve the acceptance rate.</p></td>
    </tr>
    <tr>
      <th>adapt</th>
      <td><p>Character string, defaults to "both". The type of adaption to use for the proposal see <code><a href='http://www.rdocumentation.org/packages/rbi.helpers/topics/adapt_proposal'>rbi.helpers::adapt_proposal</a></code> for details.</p></td>
    </tr>
    <tr>
      <th>adapt_scale</th>
      <td><p>Numeric, defaults to 2. The scale to use to adapt the proposal.</p></td>
    </tr>
    <tr>
      <th>min_acc</th>
      <td><p>Numeric, defaults to 0.05. The minimum target acceptance rate.</p></td>
    </tr>
    <tr>
      <th>max_acc</th>
      <td><p>Numeric, defaults to 0.4. The maximum target acceptance rate.</p></td>
    </tr>
    <tr>
      <th>fit</th>
      <td><p>Logical, defaults to <code>TRUE</code>. Should the model be fitted with 1000 samples extracted.</p></td>
    </tr>
    <tr>
      <th>posterior_samples</th>
      <td><p>Numeric, the number of samples to take from the posterior estimated using pmcmc (requires <code>fit = TRUE</code>). Defaults to 1000.</p></td>
    </tr>
    <tr>
      <th>thin</th>
      <td><p>Numeric, the thinning interval to use between posterior samples. May reduce the correlation between samples and reduces memory.</p></td>
    </tr>
    <tr>
      <th>burn_prop</th>
      <td><p>Numeric (between 0 and 1). The proportion of the chain to discard as burn-in.</p></td>
    </tr>
    <tr>
      <th>nthreads</th>
      <td><p>Numeric, defaults to 4. The number of parallel jobs to run. The most efficient option is likely to be to match the
number of cores available.</p></td>
    </tr>
    <tr>
      <th>verbose</th>
      <td><p>Logical, defaults to <code>TRUE</code>. Should progress messages and output be printed.</p></td>
    </tr>
    <tr>
      <th>libbi_verbose</th>
      <td><p>Logical, defaults to <code>FALSE</code>. Should <code>libbi</code> produce verbose progress and warnings messages.</p></td>
    </tr>
    <tr>
      <th>fitting_verbose</th>
      <td><p>Logical, defaults to <code>FALSE</code>. Should <code>libbi</code> produce verbose progress and warnings messages whilst fitting.</p></td>
    </tr>
    <tr>
      <th>browse</th>
      <td><p>Logical, defaults to <code>FALSE</code>. Should the function be run in debug mode using <code>browser</code>.</p></td>
    </tr>
    <tr>
      <th>const_pop</th>
      <td><p>Logical, defaults to <code>FALSE</code>. Should a constant population be maintained using births equals deaths.</p></td>
    </tr>
    <tr>
      <th>no_age</th>
      <td><p>Logical, defaults to <code>FALSE</code>. Should ageing be disabled.</p></td>
    </tr>
    <tr>
      <th>no_disease</th>
      <td><p>Logical, defaults to <code>FALSE</code>. Should disease be removed from the model</p></td>
    </tr>
    <tr>
      <th>save_output</th>
      <td><p>Logical, defaults to <code>FALSE</code>. Should the model results be saved as a test dataset.</p></td>
    </tr>
    <tr>
      <th>seed</th>
      <td><p>Numeric, the seed to use for random number generation.</p></td>
    </tr>
    <tr>
      <th>adapt_part_samples</th>
      <td><p>Numeric, the number of samples to take from the priors when adapting the proposal distribution. Defaults to 1000.</p></td>
    </tr>
    <tr>
      <th>adapt_part_it</th>
      <td><p>Numeric, defaults to 10. The number of iterations to use for adapting the proposal.</p></td>
    </tr>
    </table>
    
    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A LibBi model object based on the inputed test model.</p>
    

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'>
<span class='co'>## Function code:</span>
<span class='no'>fit_model</span></div><div class='output co'>#&gt; function(model = "BaseLineModel", previous_model_path = NULL, gen_data = TRUE, 
#&gt;                       run_time = 73, time_scale = "year", plot_obs = TRUE,
#&gt;                       sample_priors = TRUE, prior_samples = 1000, nparticles = NULL,
#&gt;                       adapt_particles = FALSE, adapt_part_samples = 1000, adapt_part_it = 10, 
#&gt;                       min_particles = 4, max_particles = 16,
#&gt;                       proposal_param_block = NULL, proposal_initial_block = NULL, 
#&gt;                       adapt_proposal = FALSE, adapt_prop_samples = 1000, adapt_prop_it = 10, adapt = "both",
#&gt;                       adapt_scale = 2, min_acc = 0.2, max_acc = 0.4,
#&gt;                       fit = FALSE, posterior_samples = 10000, thin = 10, burn_prop = 0, 
#&gt;                       nthreads = parallel::detectCores(), verbose = TRUE, libbi_verbose = FALSE, 
#&gt;                       fitting_verbose = TRUE, browse = FALSE,
#&gt;                       const_pop = FALSE, no_age = FALSE, no_disease = FALSE,
#&gt;                       save_output = FALSE, dir_path = NULL, dir_name = NULL,
#&gt;                       seed = 1234) {
#&gt; 
#&gt; 
#&gt; # Util functions ----------------------------------------------------------
#&gt; 
#&gt;   ##Plot and save
#&gt;   plot_obj &lt;- function(obj, p_param, append_name = NULL, save = FALSE) {
#&gt;     if (!is.null(p_param[[obj]]))
#&gt;     {
#&gt;       message("Plotting: ", obj)
#&gt;       
#&gt;       plot &lt;- p_param[[obj]] + theme_minimal()
#&gt;       
#&gt;       print(plot)
#&gt;       
#&gt;       if (!is.null(append_name)) {
#&gt;         obj &lt;- paste0(append_name, "-", obj)
#&gt;       }
#&gt;       
#&gt;       if (save) {
#&gt;         ggsave(paste0(obj, ".png"), plot, path = plots_dir, dpi = 320)
#&gt;       }
#&gt; 
#&gt;     }
#&gt;   }
#&gt; 
#&gt; # Check parameters --------------------------------------------------------
#&gt; 
#&gt; if(burn_prop &gt; 1 || burn_prop &lt; 0) {
#&gt;   stop("The burn in proportion must be less or equal to 1 and greater than or equal to 0.")
#&gt; }  
#&gt; 
#&gt;   # Set up model directory --------------------------------------------------
#&gt; if (save_output) {
#&gt;   if (is.null(dir_path)) {
#&gt;     dir_path &lt;- "."
#&gt;   }
#&gt;   
#&gt;   if (is.null(dir_name)) {
#&gt;     dir_name &lt;- "model-run"
#&gt;   }
#&gt;   
#&gt;   ## Add time to filename
#&gt;   dir_name &lt;- paste0(dir_name, "-", str_replace(Sys.time(), " ", "_"))
#&gt;   
#&gt;   ## Construct path
#&gt;   model_dir &lt;- file.path(dir_path, dir_name)
#&gt;   
#&gt;   message("Model output: ", model_dir)
#&gt;   
#&gt;   ## Make the folder
#&gt;   if (!dir.exists(model_dir)) {
#&gt;     dir.create(model_dir)
#&gt;     
#&gt;     ## Make a sub folder for data
#&gt;     data_dir &lt;- file.path(model_dir, "data")
#&gt;     
#&gt;     dir.create(data_dir)
#&gt;     
#&gt;     ## Make a sub folder for plots
#&gt;     plots_dir &lt;- file.path(model_dir, "plots")
#&gt;     
#&gt;     dir.create(plots_dir)
#&gt;     
#&gt;     ## Make a sub folder for libbi output
#&gt;     libbi_dir &lt;- file.path(model_dir, "libbi")
#&gt;     
#&gt;     dir.create(libbi_dir)
#&gt;   }
#&gt;   
#&gt;   ## Make the log file
#&gt;   logs &lt;- file.path(model_dir, "log.txt")
#&gt;   con &lt;- file(logs)
#&gt;   
#&gt;   ## Send Output to log
#&gt;   sink(con, append = TRUE)
#&gt;   sink(con, type = "message", append = TRUE)
#&gt; }
#&gt;   
#&gt;   # Set the time scale for the model ----------------------------------------
#&gt; 
#&gt; 
#&gt;   if (time_scale == "year") {
#&gt;     time_scale_numeric &lt;- 1
#&gt;   }else if (time_scale == "month") {
#&gt;     time_scale_numeric &lt;- 12
#&gt;   }else{
#&gt;     stop("Only a yearly (year) or monthly (month) timescale have been implemented.")
#&gt;   }
#&gt;   
#&gt; 
#&gt;   # Set the number of particles ---------------------------------------------
#&gt; 
#&gt;   if (is.null(nparticles)) {
#&gt;     nparticles &lt;- run_time * time_scale_numeric
#&gt;   }  
#&gt;   
#&gt;   # Load the model ----------------------------------------------------------
#&gt;   
#&gt;   if (is.character(model)) {
#&gt;     model_file &lt;- system.file(package="ModelTBBCGEngland", paste0("bi/", model, ".bi"))
#&gt;     
#&gt;     tb_model_raw &lt;- bi_model(model_file)
#&gt;     
#&gt;   }else{
#&gt;     tb_model_raw &lt;- model
#&gt;   }
#&gt;   
#&gt;   
#&gt; 
#&gt; # Specify model setup conditions ------------------------------------------
#&gt; 
#&gt;   if (time_scale == "year") {
#&gt;     tb_model_raw &lt;- fix(tb_model_raw, ScaleTime = 1 / 12)
#&gt;   }else if (time_scale == "month") {
#&gt;     tb_model_raw &lt;- fix(tb_model_raw, ScaleTime = 1)
#&gt;   }else{
#&gt;     stop("Only a yearly (year) or monthly (month) timescale have been implemented.")
#&gt;   }
#&gt;   
#&gt;   if (const_pop) {
#&gt;     tb_model_raw &lt;- fix(tb_model_raw, const_pop = 1)
#&gt;   }
#&gt;   
#&gt;   if (no_age) {
#&gt;     tb_model_raw &lt;- fix(tb_model_raw, no_age = 1)
#&gt;   }
#&gt;   
#&gt;   if (no_disease) {
#&gt;     tb_model_raw &lt;- fix(tb_model_raw, no_disease = 1)
#&gt;   }
#&gt;   
#&gt; 
#&gt; # Add the proposal block to the model -------------------------------------
#&gt;  if (!is.null(proposal_param_block)) {
#&gt;    tb_model_raw &lt;- add_block(tb_model_raw, "proposal_parameter", proposal_param_block)
#&gt;  }
#&gt;   
#&gt;   
#&gt;   if (!is.null(proposal_initial_block)) {
#&gt;     tb_model_raw &lt;- add_block(tb_model_raw, "proposal_initial", proposal_initial_block)
#&gt;   }
#&gt; 
#&gt; 
#&gt;   # Allow for interactive debugging -----------------------------------------
#&gt;   
#&gt;   if (browse) {
#&gt;     browser() 
#&gt;   }
#&gt; 
#&gt; 
#&gt; # Set up model input ------------------------------------------------------
#&gt; 
#&gt; ## See ?setup_model_input or details 
#&gt; input &lt;- setup_model_input(run_time, time_scale_numeric)
#&gt; 
#&gt; ## Save formated data
#&gt; if (save_output) {
#&gt;   saveRDS(input, file.path(data_dir, "input.rds"))
#&gt; }
#&gt; 
#&gt; 
#&gt; # Set up abs data ---------------------------------------------------------
#&gt; 
#&gt; ## See ?setup_model_obs for details
#&gt; obs &lt;- setup_model_obs()
#&gt; 
#&gt; # Reset obs and input if running with test SIR Model ----------------------
#&gt;   if (model == "SIR") {
#&gt;     obs &lt;- NULL
#&gt;     input &lt;- NULL
#&gt;   }
#&gt;   
#&gt; # Generate data from the model --------------------------------------------
#&gt;   if (gen_data) {
#&gt;     
#&gt;     if (verbose) {
#&gt;       message("Generating data from model")
#&gt;     }
#&gt;     
#&gt;     tb_data &lt;- bi_generate_dataset(tb_model_raw, end_time = run_time * time_scale_numeric, 
#&gt;                                    input = input, obs = obs, 
#&gt;                                    noutputs = floor(run_time / 7),
#&gt;                                    seed = seed, verbose = libbi_verbose)
#&gt;     
#&gt;     if (verbose) {
#&gt;       message("Summary of generated model data")
#&gt;       print(tb_data)
#&gt;     }
#&gt;     
#&gt;     
#&gt;     obs &lt;- bi_read(tb_data, type = "obs")
#&gt;     
#&gt;     if (verbose) {
#&gt;       message("Variables in the generated data")
#&gt;       print(names(obs))
#&gt;     }
#&gt;     
#&gt;   }
#&gt;   
#&gt;   ## Save formated data
#&gt;   if (save_output) {
#&gt;     saveRDS(obs, file.path(data_dir, "obs.rds"))
#&gt;   }
#&gt;   
#&gt;   
#&gt;   # Plot incidence generated by the model -----------------------------------
#&gt;   if (plot_obs) {
#&gt;     
#&gt;     time &lt;- NULL; value &lt;- NULL;
#&gt;     
#&gt;     message("Plot historic number of pulmonary cases detected each year:")
#&gt;     p_hist_cases &lt;- obs$YearlyHistPInc %&gt;% 
#&gt;       dplyr::filter(time &gt; 0) %&gt;% 
#&gt;       ggplot(aes(x = time, y = value)) +
#&gt;       geom_point(size = 1.2) +
#&gt;       geom_line(size = 1.1, alpha = 0.6) +
#&gt;       theme_minimal() +
#&gt;       labs(x = "Time",
#&gt;            y = "Yearly notified cases")
#&gt;     
#&gt;     print(p_hist_cases)
#&gt;     
#&gt;     if (save_output) {
#&gt;       ggsave("obs-hist-pul-cases.png", path = plots_dir, dpi = 320)
#&gt;     }
#&gt;     
#&gt;     message("Plot number of cases detected each year:")
#&gt;     p_cases &lt;- obs$YearlyInc %&gt;% 
#&gt;       dplyr::filter(time &gt; 0) %&gt;% 
#&gt;       ggplot(aes(x = time, y = value)) +
#&gt;       geom_point(size = 1.2) +
#&gt;       geom_line(size = 1.1, alpha = 0.6) +
#&gt;       theme_minimal() +
#&gt;       labs(x = "Time",
#&gt;            y = "Yearly notified cases")
#&gt;     
#&gt;     print(p_cases)
#&gt;     if (save_output) {    
#&gt;       ggsave("obs-cases.png", path = plots_dir, dpi = 320)
#&gt;     }
#&gt;     
#&gt;   message("Plot number of cases detected each year, stratified by age group:")
#&gt;     p_age_cases &lt;- obs$YearlyAgeInc %&gt;% 
#&gt;       dplyr::filter(time &gt; 0) %&gt;% 
#&gt;       ggplot(aes(x = time, y = value)) +
#&gt;       geom_point(size = 1.2) +
#&gt;       geom_line(size = 1.1, alpha = 0.6) +
#&gt;       theme_minimal() +
#&gt;       labs(x = "Time",
#&gt;            y = "Yearly notified cases") +
#&gt;       facet_wrap(~age, scales = "free_y")
#&gt;     
#&gt;     print(p_age_cases)
#&gt;     
#&gt;     if (save_output) {
#&gt;       ggsave("obs-age-cases.png", path = plots_dir, dpi = 320)
#&gt;     }
#&gt; 
#&gt;   }
#&gt; 
#&gt;   
#&gt;   # Load the model ----------------------------------------------------------
#&gt;   
#&gt;   if (verbose) {
#&gt;     message("Load the model as a compiled libbi object")
#&gt;   }
#&gt; 
#&gt;   tb_model &lt;- libbi(tb_model_raw, 
#&gt;                     input = input, 
#&gt;                     obs = obs,
#&gt;                     end_time = run_time * time_scale_numeric, 
#&gt;                     noutputs = run_time * time_scale_numeric,
#&gt;                     nparticles = nparticles, nthreads = nthreads, 
#&gt;                     verbose = libbi_verbose,
#&gt;                     seed = seed)
#&gt;   
#&gt;   if (!is.null(previous_model_path)) {
#&gt;     message("Replacing the default liBBi model with a previously run model - this may not have the same settings as the current run.")
#&gt;     tb_model &lt;- read_libbi(previous_model_path)
#&gt;     
#&gt;     if (verbose) {
#&gt;       message("Previous Model: ")
#&gt;       print(tb_model) 
#&gt;       print(tb_model$model)
#&gt;     }
#&gt;   }
#&gt;   # Sample from priors ------------------------------------------------------
#&gt; if (sample_priors) {
#&gt;   if (verbose) {
#&gt;     message("Sample priors")
#&gt;   }
#&gt;   
#&gt;   priors &lt;- sample(tb_model, target = "prior", nsamples = prior_samples)
#&gt;   
#&gt;   if (verbose) {
#&gt;     message("Summary of prior sampling")
#&gt;     print(priors)
#&gt;     message("Load priors")
#&gt;   }
#&gt;   
#&gt;   
#&gt;   if (verbose) {
#&gt;     message("Plot priors")
#&gt;   
#&gt;     p_prior &lt;- plot(priors , plot = FALSE)
#&gt;     
#&gt;     objects &lt;- c("states", "densities", "traces", "correlations", "noises", "likelihoods")
#&gt;     
#&gt;     map(objects, ~ plot_obj(., p_prior, append_name = "prior", save = save_output))
#&gt;       
#&gt;     if (save_output) {
#&gt;       saveRDS(p_prior$data, file.path(data_dir, "prior-params.rds"))
#&gt;     }
#&gt; 
#&gt;   }
#&gt; }  
#&gt; 
#&gt;   # Adapting the number of particles ----------------------------------------
#&gt;   
#&gt;   if (adapt_particles) {
#&gt;     if (verbose) {
#&gt;       message("Adapting particles starting with ", min_particles, " up to a maximum of ", max_particles)
#&gt;     }
#&gt;     
#&gt;     ## Add all variables as outputs to the model.
#&gt;     lim_out_model &lt;- tb_model$model
#&gt;     tb_model$model &lt;- everything_from_model(tb_model$model)
#&gt; 
#&gt;     adapt_mutli_particles &lt;- function(iteration, libbi) {
#&gt;       if (verbose) {
#&gt;         message("Adapting particles iteration: ", iteration)
#&gt;         message("Initial sampling using the prior as the proposal.")
#&gt;       }
#&gt;       
#&gt;       tb_model &lt;- tb_model %&gt;% 
#&gt;         sample(proposal = "prior", nsamples = adapt_part_samples, verbose = libbi_verbose,
#&gt;                options = list(with="transform-initial-to-param"), seed = iteration + seed)
#&gt;       
#&gt;       if (verbose) {
#&gt;         message("Starting particle adaption")
#&gt;       }
#&gt;       
#&gt;       tb_model &lt;- tb_model %&gt;% 
#&gt;         adapt_particles(min = min_particles, max = max_particles, 
#&gt;                         quiet = !verbose,
#&gt;                         verbose = libbi_verbose)
#&gt;       
#&gt;       particles &lt;- tb_model$options$nparticles
#&gt;       return(particles)
#&gt;     }
#&gt;     
#&gt;     particles &lt;- map_dbl(1:adapt_part_it, ~  adapt_mutli_particles(., tb_model))
#&gt; 
#&gt;     
#&gt;     if (save_output) {
#&gt;       saveRDS(particles, file.path(libbi_dir, "particles.rds"))
#&gt;     }
#&gt;     
#&gt;     med_particles &lt;- particles %&gt;% 
#&gt;       median %&gt;% 
#&gt;       ceiling
#&gt;     
#&gt;     if (verbose) {
#&gt;       message("Choosing ", med_particles, "based on ", adapt_part_it, " iterations each using ", adapt_part_samples, ".")
#&gt;       message("The maximum number of particles selected was ", max(particles), " with a minimum of", min(particles))
#&gt;       message("The mean number of particles selected was ", mean(particles), " with a standard deviation of ", sd(particles))
#&gt;     }
#&gt;     
#&gt;  
#&gt;     tb_model$model &lt;- lim_out_model
#&gt;     tb_model$options$nparticles &lt;- med_particles
#&gt;     
#&gt;   }
#&gt;   
#&gt;   
#&gt;   # Adapting the proposal ---------------------------------------------------
#&gt;   
#&gt;   if (adapt_proposal) {
#&gt;     if (verbose) {
#&gt;       message("Adapting proposal with a min acceptance of ", min_acc, " and a maximum acceptance of ", max_acc)
#&gt;       message("Running for ", adapt_prop_it, " iterations with ", adapt_prop_samples, " samples each time.")
#&gt;     }
#&gt;     
#&gt;     tb_model &lt;- tb_model %&gt;% 
#&gt;       sample(proposal = "model", nsamples = adapt_prop_samples, verbose = libbi_verbose) %&gt;% 
#&gt;       adapt_proposal(min = min_acc, max = max_acc,
#&gt;                      max_iter = adapt_prop_it, adapt = adapt, 
#&gt;                      scale = adapt_scale, truncate = TRUE, 
#&gt;                      quiet = !verbose)
#&gt;     
#&gt;     prop_param_block &lt;- get_block(tb_model$model, "proposal_parameter")
#&gt;     prop_initial_block &lt;- get_block(tb_model$model, "proposal_initial")
#&gt;     
#&gt;     if (verbose) {
#&gt;       message("Adapted proposal distribution")
#&gt;     
#&gt;       print(prop_param_block)
#&gt;       print(prop_initial_block)
#&gt;     }
#&gt;     
#&gt;     if (save_output) {
#&gt;       saveRDS(prop_param_block, file.path(libbi_dir, "proposal-param-block.rds"))
#&gt;       saveRDS(prop_initial_block, file.path(libbi_dir, "proposal-initial-block.rds"))
#&gt;     }
#&gt;   }
#&gt;   
#&gt;   
#&gt;   # Model fitting ------------------------------------------------------
#&gt;   
#&gt;   
#&gt;   if (fit) {
#&gt;     if (verbose) {
#&gt;       message("Fitting using PMCMC")
#&gt;     }
#&gt;     
#&gt;     
#&gt;     tb_model &lt;- tb_model %&gt;% 
#&gt;       sample(target = "posterior",
#&gt;              proposal = "model", sample_obs = TRUE, 
#&gt;              nsamples = posterior_samples,
#&gt;              thin = thin,
#&gt;              verbose = fitting_verbose)
#&gt;     
#&gt;     
#&gt;     if (verbose) {
#&gt;       message("Summary of fitted model")
#&gt;       print(tb_model)
#&gt;     }
#&gt;     
#&gt;     if (save_output) {
#&gt;       save_libbi(tb_model, file.path(libbi_dir, "posterior.rds"))
#&gt;     }
#&gt;     
#&gt; 
#&gt; # Plot posterior ----------------------------------------------------------
#&gt; 
#&gt;     if (verbose) {
#&gt;       message("Plot posterior")
#&gt;       
#&gt;       p_posterior &lt;- plot(tb_model, plot = FALSE)
#&gt;       
#&gt;       objects &lt;- c("states", "densities", "traces", "correlations", "noises", "likelihoods")
#&gt;       
#&gt;       map(objects, ~ plot_obj(., p_posterior, append_name = "posterior", save = save_output))
#&gt;       
#&gt;       if (save_output) {
#&gt;         saveRDS(p_posterior$data, file.path(data_dir, "posterior-params.rds"))
#&gt;       }
#&gt;       
#&gt;     }
#&gt;     
#&gt;     if (save_output) {
#&gt;       save_libbi(tb_model, file.path(libbi_dir, "posterior"))
#&gt;     }
#&gt;     
#&gt; 
#&gt; # Evaluate run ------------------------------------------------------------
#&gt;     
#&gt;     burn &lt;- floor(posterior_samples / thin * burn_prop)
#&gt;     
#&gt;     dic &lt;- DIC(tb_model, burn = burn)
#&gt;     
#&gt;     message("Model DIC: ", dic)
#&gt;     
#&gt;     if (save_output) {
#&gt;       saveRDS(dic, file = file.path(libbi_dir, "dic.rds"))
#&gt;     }
#&gt; 
#&gt;   }
#&gt;   
#&gt; 
#&gt;   if (save_output) {
#&gt;     sink(file = NULL) 
#&gt;     sink(file = NULL, type = "message")
#&gt;   }
#&gt;   
#&gt;   if (!fit &amp;&amp; !adapt_particles &amp;&amp; !adapt_proposal &amp;&amp; sample_priors) {
#&gt;     tb_model &lt;- priors
#&gt;   }
#&gt;   
#&gt;   return(tb_model)
#&gt; }
#&gt; &lt;environment: namespace:ModelTBBCGEngland&gt;</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      
      <li><a href="#value">Value</a></li>
      
      <li><a href="#examples">Examples</a></li>
    </ul>

  </div>
</div>

      <footer>
      <div class="copyright">
  <p>Developed by Sam Abbott.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
   </div>

  

  </body>
</html>

