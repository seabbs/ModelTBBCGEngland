---
title: "Extract BCG Effectiveness at Preventing Active Disease"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
library(tidyverse)
library(idmodelr)
library(knitr)
library(broom)
```

BCG effectiveness at preventing active disease is extrapolated from several sources for both vaccination at birth and vaccination at school-age. 

# Vaccine Effecetiveness after Vaccination at School-Age

For vaccination 10-15, 15-20, 20-25, and 25-29 years ago vaccine effectivness is based on values estimated in [this](https://academic.oup.com/ije/article/47/1/193/4098108) study. As this study did not provide estimates for vaccination within 10 years the [original MRC trial](http://www.bmj.com/content/2/6082/293) of the BCG vaccine was used to provide estimates. A log normal distribution has been assumed, extrapolated from the reported risk ratio point estimates with 95% confidence intervals. The MRC trial only provided point estimates for the effectiveness of the BCG vaccine. Risk ratios have been re-estimated from the reported data using Poisson regression for those vaccinationed within 5 years and for those vaccinated within 10 years.[@Sterne1998] Updated estimates were then validated against previous published point estimates.

1. Get raw data from MRC and estimate risk ratios

```{r}
mrc_data <- tibble(
  cases = c(160, 67),
  vac_status = "unvaccinated",
  age = c("0-4","5-9")
) %>% 
  bind_rows(
    tibble(
      cases = c(27, 22),
      vac_status = "vaccinated",
      age = c("0-4","5-9")
    )
  ) %>% 
  left_join(
    tibble(vac_status = c("unvaccinated", "vaccinated"),
           population = c(12867, 13598))
  ) %>% 
  mutate(vac_status = vac_status %>% 
           factor(levels = c("unvaccinated", "vaccinated")))

mrc_rr <- mrc_data %>% 
  group_by(age) %>% 
  nest() %>% 
  mutate(model = map(data, ~ glm(cases ~ vac_status + offset(log(population)), family = poisson, data = .))) %>% 
  mutate(output = map(model, ~ tidy(., exponentiate = TRUE, conf.int = TRUE, conf.level = 0.95))) %>% 
  mutate(output = map(output, ~ slice(., 2))) %>% 
  unnest(output) %>% 
  dplyr::select(-std.error, -statistic, -p.value, -data, -model, -term) %>% 
  mutate_if(is.numeric, ~round(., 2)) %>% 
  mutate(source = "mrc")
```

1. Get risk ratio data from the IJE paper.

```{r}
ije_rr <- tibble(
  age = c("10-14", "15-19", "20-24", "25-29"),
  estimate = c(0.44, 0.43, 0.75, 0.79),
  conf.low = c(0.28, 0.29, 0.52, 0.45),
  conf.high = c(0.67, 0.64, 1.1, 1.39),
  source = "ije"
)
```

1. Combine all risk ratios. 

```{r}
all_rr <- mrc_rr %>% 
  bind_rows(ije_rr)
```

1. Estimated effectiveness.

```{r}
eff_bcg <- all_rr %>% 
  mutate_if(is.numeric, ~ (1 - .) * 100) %>% 
  mutate(pretty_eff = paste0(estimate, " (", conf.high, ", ", conf.low, ")")) %>% 
  dplyr::select(`Time since vaccination (years)` = age, `Effectiveness (%)` = pretty_eff)

eff_bcg

devtools::use_data(eff_bcg, overwrite = TRUE)
 #' Add as raw csv
write_csv(eff_bcg, "data-proc/eff_bcg.csv")
```

1. Plot vaccine effectivieness over time

```{r}
all_rr %>% 
  mutate_if(is.numeric, ~ (1 - .)) %>% 
  mutate(age = factor(age, levels = all_rr$age)) %>% 
  mutate(numeric_age = as.numeric(age)) %>% 
  ggplot(aes(x = numeric_age, y = estimate, ymin = conf.low, ymax = conf.high)) +
  geom_point(size = 1.4) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_linerange(size = 1.2, alpha = 0.6) +
  theme_minimal()
```

1. Estimate the logged distribution.

```{r}
log_rr_bcg <- all_rr %>% 
  mutate(log_mean = estimate_norm_dist_from_ci(log(conf.low), log(conf.high))$mean,
         log_sd = estimate_norm_dist_from_ci(log(conf.low), log(conf.high))$sd) %>% 
  mutate_at(vars(log_mean, log_sd), ~ round(., 2)) %>% 
  mutate(log_dist = paste0("(", log_mean, ", ", log_sd, ")"))

log_rr_bcg 

devtools::use_data(log_rr_bcg, overwrite = TRUE)
 #' Add as raw csv
write_csv(log_rr_bcg, "data-proc/log_rr_bcg.csv")
```

1. Test the log distribution

```{r}
sampled_eff <- log_rr_bcg %>% 
  group_by(age) %>% 
  mutate(sample = list(rnorm(1e2, mean = log_mean, sd = log_sd)),
         exp_sample = map(sample, exp),
         point_rr = map(exp_sample, mean),
         point_eff = map(point_rr, ~ 1 - .))

sampled_eff %>% 
  unnest(point_eff) %>% 
  dplyr::select(age, point_eff) %>% 
  mutate(point_eff = round(point_eff * 100, 1)) %>% 
  left_join(eff_bcg, by = c("age" = "Time since vaccination (years)"))
```

1. Estimate a decay parameter with uncertainty

```{r}
sampled_eff %>% 
  mutate(sample = map(sample, ~ tibble(sample = 1:length(.), value = .))) %>% 
  select(age, estimate, sample) %>% 
  unnest %>% 
  mutate(age_numeric = age %>% 
           factor(levels = sampled_eff$age %>% unique) %>% 
           as.numeric() %>% 
           {. - 1}) %>% 
  ungroup %>% 
  group_by(sample) %>% 
  nest() %>% 
  mutate(model = map(data, ~ lm(value ~ age_numeric, data = .)),
         preds = map(model, ~ predict(., newdata = data.frame(age_numeric = 0:5)) %>% 
                       {1 - exp(.)}),
         coeffs = map(model, ~ broom::tidy() %>% 
                        select(term, estimate, std.error))) -> tmp
tmp$preds 
tmp$model[[1]] %>% broom::tidy()
```